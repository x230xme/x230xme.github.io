<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Uniswap XYK Calculator</title>
<style>
@import url('https://fonts.googleapis.com/css?family=Inter&display=swap');
@import url('https://fonts.googleapis.com/css?family=Fira+Code&display=swap');
body {
  background-color: #111;
  font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  color: #fff;
  -webkit-font-smoothing: antialiased;
}
a {color: #fff;}
.box {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}
.box.row {
  flex-direction: row;
  margin: 0 auto;
  width: 100%;
}
.item {
  padding: 15px 0px;
}

.item label {
  margin:0 0 3px 0;
  text-align: left;
  font-size: 19px;
  display: block;
}

.cell {
  padding: 5px 10px 5px 10px;
  margin: 0;
  width: 90%;

}
input {
  outline: none;
  border: 1px solid #222;
  border-radius: 10px;
  flex: 1 1 auto;
  padding: 10px;
  font-size: 24px;
  color: #fff;
  background-color: rgba(255,255,255,0.01);
  width: 100%;
  margin: 0;
  text-overflow: ellipsis;
  box-sizing: border-box;
  font-family: "Fira Code", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
}
@media (min-width: 768px){

  .cell {
    width: 100%;
    max-width: 600px

  }
  .box.row {

    width: 600px;
  }
  #currentlLiquidity, #newLiquidity  {
  }
}
h2 {
    font-size: 20px;
    font-weight: 300;
}
#currentlLiquidity {

}
#newLiquidity {

}
#transaction {
  background: #2b2b2b;
  box-shadow: rgba(0, 0, 0, 0.01) 0px 0px 1px, rgba(0, 0, 0, 0.04) 0px 4px 8px, rgba(0, 0, 0, 0.04) 0px 16px 24px, rgba(0, 0, 0, 0.01) 0px 24px 32px;
  border-radius: 10px;

}
#transaction div {
  margin:10px
}
#transaction label {
  display: flex;
  flex-direction: row;
  flex-wrap: nowrap;
  background: #222;
  margin:0 -10px
}
#transaction label a {
  flex-grow: 2;
  text-align: center;
  padding: 10px;
  border-bottom: 2px solid #222;
  text-decoration: none;
}
#transaction label a.selected {
  border-bottom: 2px solid #f2a52b;

}
#transaction p {
  line-height:1.3;
  padding:5px;
}
#bos {
  margin-top: 15px;
}
#tests {
    max-width: 600px;
    margin: 10px auto;
    line-height: 1.6;
    border-top: 30px solid #222;
    padding-top: 10px;
}
</style>


</head>

<body>
<div class="box">
  <div id="uni"></div>
	<p>The numbers in <em>Current liquidity</em> taken from the "pooled tokens" values found <a href="https://info.uniswap.org/pair/0x88ff79eb2bc5850f27315415da8685282c7610f9">here</a>. Learn more about this <a href="https://medium.com/scalar-capital/uniswap-a-unique-exchange-f4ef44f807bf#:~:text=Uniswap's%20goal%20for%20this%20particular,and%20k%20is%20the%20product.">here</a>.</p>

<div class="cell" id="transaction">
<p>Test a Buy or Sell to see price movement based on current liquidity.</p>

    <label><a href="#" id="buyButton" class="selected">Buy</a> <a id="sellButton" href="#">Sell</a></label>
    <div>
        <input id="bos" type="text" placeholder="Amount to buy or sell" />
    </div>
    <div>
      <p>Price</p><input id="priceL" type="text" disabled />
    </div>

  </div>
</div>
<div class="box row">

<div class="cell" id="currentlLiquidity">
  <h2>
    Liquidity before trade
  </h2>
  <div class="item">
    <label>ESD</label><input id="esdLiqInit" type="text" />
  </div>
  <div class="item">
    <label>USDC</label><input id="usdcLiqInit" type="text" />
  </div>
</div>

<div class="cell" id="newLiquidity">
  <h2>
    Liquidity after trade
  </h2>
  <div class="item">
    <label>ESD</label><input id="esdLiqNew" type="text" disabled />
  </div>
  <div class="item">
    <label>USDC</label><input id="usdcLiqNew" type="text" disabled />
  </div>
</div>
</div>
<div id="tests"><p>How does the liquidty pool affect the price when trades are made? Try some buying and selling with <a id="liqFive" href="#">5m</a> total liquidity and <a id="liqOneTwentyFive" href="#">125m</a> total liquidity and see how different sells affect the price with different levels of liquidity.</p></div>
<script>

const url = 'https://api.ethplorer.io/getAddressInfo/0x88ff79eb2bc5850f27315415da8685282c7610f9?apiKey=EK-eGQ96-sc4Dbsu-59s1f'
fetch(url)
.then(res => res.json())
.then((data) => {

const esdUniVal = data.tokens[1].balance.toLocaleString('fullwide', {useGrouping:false})/1000000000000000000;
const usdcUniVal = data.tokens[2].balance.toLocaleString('fullwide', {useGrouping:false})/1000000;
const esdLiqInit = document.getElementById('esdLiqInit');
const usdcLiqInit = document.getElementById('usdcLiqInit');
const esdLiqNew = document.getElementById('esdLiqNew');
const usdcLiqNew = document.getElementById('usdcLiqNew');
const priceL = document.getElementById('priceL');
const bos = document.getElementById('bos');
const buyButton = document.getElementById('buyButton');
const sellButton = document.getElementById('sellButton');


esdLiqInit.value = esdUniVal;
usdcLiqInit.value = usdcUniVal;
priceL.value = usdcLiqInit.value / esdLiqInit.value;

bos.focus();
bos.select();

const bsButtonHandler = function(e) {
  sellButton.classList.remove('selected');
  buyButton.classList.remove('selected');
  this.classList.add('selected');
  bosHandler();
}

// for changing the initial liquidity fields
const liquidityHandler = function(e) {

  // reset new liquidity fields to avoid confusion:
  esdLiqNew.value = '';
  usdcLiqNew.value = '';
  // reset buy or sell field
  bos.value = '';
  // calculate price based on initial liquidity
  priceL.value = usdcLiqInit.value / esdLiqInit.value;

}

// for calculating a buy or sell
const bosHandler = function(e) {

  // recalculating k here:
  let k = esdLiqInit.value * usdcLiqInit.value

  //console.log(usdcLiqNew.value);
  if (bos.value < 0 || sellButton.classList.contains('selected')) {

    // selling so adding ESD to the pool:
    esdLiqNew.value = Number(esdLiqInit.value) + Number(bos.value);
    // calculate new USDC supply in pool:
    usdcLiqNew.value = k / esdLiqNew.value;

  } else if (bos.value > 0) {
    // buying so adding USDC to the pool:
    usdcLiqNew.value = Number(usdcLiqInit.value) + Number(bos.value);

    // calculate new ESD supply in pool:
    esdLiqNew.value = k / usdcLiqNew.value;



  }

  // New ESD price
  priceL.value = usdcLiqNew.value / esdLiqNew.value;
}

usdcLiqInit.addEventListener('input', liquidityHandler);
esdLiqInit.addEventListener('input', liquidityHandler);
bos.addEventListener('input', bosHandler);
buyButton.addEventListener('click', bsButtonHandler);
sellButton.addEventListener('click', bsButtonHandler);

document.getElementById('liqOneTwentyFive').addEventListener('click', function(e){esdLiqInit.value = '62500000';usdcLiqInit.value = '62500000';liquidityHandler();});
document.getElementById('liqFive').addEventListener('click', function(e){esdLiqInit.value = '2500000';usdcLiqInit.value = '2500000';liquidityHandler();});


});


</script>
</body>
</html>
